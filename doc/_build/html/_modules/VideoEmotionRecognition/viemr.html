<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VideoEmotionRecognition.viemr &mdash; viemr 0.2.8 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=9265798b"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            viemr
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../Gettingstarted.html">Getting started</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">VideoEmotionRecognition Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">viemr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">VideoEmotionRecognition.viemr</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for VideoEmotionRecognition.viemr</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Here is the main class that makes this module, VideoEmotionRecognition</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">gdown</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="c1">#import whisperx</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">transformers</span>
<span class="kn">import</span> <span class="nn">webvtt</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">ffmpeg</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">moviepy.editor</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">torchaudio</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">kneighbors_graph</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">sentence_transformers</span> <span class="kn">import</span> <span class="n">SentenceTransformer</span>
<span class="kn">from</span> <span class="nn">deepface</span> <span class="kn">import</span> <span class="n">DeepFace</span>
<span class="c1">#from src.models import Wav2Vec2ForSpeechClassification, HubertForSpeechClassification</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoConfig</span><span class="p">,</span> <span class="n">Wav2Vec2FeatureExtractor</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoTokenizer</span><span class="p">,</span> <span class="n">AutoModelForSeq2SeqLM</span><span class="p">,</span> <span class="n">pipeline</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">RobertaTokenizerFast</span><span class="p">,</span> <span class="n">BertForSequenceClassification</span>
<div class="viewcode-block" id="VideoEmotionRecognition"><a class="viewcode-back" href="../../modules.html#VideoEmotionRecognition.viemr.VideoEmotionRecognition">[docs]</a><span class="k">class</span> <span class="nc">VideoEmotionRecognition</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mp4</span><span class="p">):</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;newfile.log&quot;</span><span class="p">,</span>
        <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">filemode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing the class&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mp4</span> <span class="o">=</span> <span class="n">mp4</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading the arousal_valence map&quot;</span><span class="p">)</span>

        <span class="n">url1</span> <span class="o">=</span> <span class="s1">&#39;https://drive.google.com/uc?id=1yJBHU8Zl4MuoQfJqkPgVDwJfYRJDPUAH&#39;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;emotions_coord.xlsx&#39;</span>
        <span class="n">gdown</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">url1</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emotions_coord</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully initialized&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    add_emotions</span>
<span class="sd">    ---------------</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="VideoEmotionRecognition.add_emotions"><a class="viewcode-back" href="../../modules.html#VideoEmotionRecognition.viemr.VideoEmotionRecognition.add_emotions">[docs]</a>    <span class="k">def</span> <span class="nf">add_emotions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_emotions</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          Use this to add the arousal and valence of a new emotion by passing a series or a dataframe with it&#39;s name, x coordinate</span>
<span class="sd">          and y coordinate in this order. Useful when changing the model so that the emotions classified by this model are recognized.</span>

<span class="sd">          Args:</span>
<span class="sd">            **new_emotions (pandas series/dataframe)**: new emotion to be added with it&#39;s name, arousal and valence coordinates values.</span>

<span class="sd">          Return:</span>
<span class="sd">            Nothing.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emotions_coords</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">emotions_coords</span><span class="p">,</span><span class="n">new_emotions</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emotions_coords</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    transcript</span>
<span class="sd">    ----------</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="VideoEmotionRecognition.transcript"><a class="viewcode-back" href="../../modules.html#VideoEmotionRecognition.viemr.VideoEmotionRecognition.transcript">[docs]</a>    <span class="k">def</span> <span class="nf">transcript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;whisperx&quot;</span><span class="p">,</span> <span class="n">min_time</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          One of the main functions of this module. It&#39;s responsible for transforming the audio of a video into text,</span>
<span class="sd">          organizing it&#39;s sentences in a dataframe with the transcription and it&#39;s time frames of start and end. </span>
<span class="sd">          </span>
<span class="sd">          This function is used in all the modalities of classification, but doesn&#39;t need to be run manually, </span>
<span class="sd">          being automatically used in each modality. </span>

<span class="sd">          Args:</span>
<span class="sd">            **method (string)**: placeholder for future integration of new models.</span>

<span class="sd">            **min_time (int)**: minimun time in seconds for a sentence to be added into the dataframe. Increassing this value will discard shorter sentences</span>

<span class="sd">          Return:</span>
<span class="sd">            Nothing.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running the whisperx transcription&quot;</span><span class="p">)</span>
        <span class="n">bashCommand</span> <span class="o">=</span> <span class="s2">&quot;whisperx --compute_type float32 --output_format vtt &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp4</span>
        <span class="c1">#os.system(bashCommand)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully transcripted&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating the Dataframe from the vtt&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_vtt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp4</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;mp4&quot;</span><span class="p">,</span> <span class="s2">&quot;vtt&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">__time_diff</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_time</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully generated the dataframe&quot;</span><span class="p">)</span></div>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    text</span>
<span class="sd">    ----</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="VideoEmotionRecognition.text"><a class="viewcode-back" href="../../modules.html#VideoEmotionRecognition.viemr.VideoEmotionRecognition.text">[docs]</a>    <span class="k">def</span> <span class="nf">text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emot_pipe</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">encoder_text</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">redo</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">          One of the main functions of this module. It&#39;s responsible for classifying</span>
<span class="sd">          the emotions present in a clip based on the transcription of it&#39;s audio. </span>
<span class="sd">          </span>
<span class="sd">          Can be used manually or indirectly via the emotion_recogniton(modality = &quot;transcript&quot;) method to generate a dataframe</span>
<span class="sd">          with each sentence of a video transcripted with it&#39;s timestamps, the emotion that is predominant in the text of this</span>
<span class="sd">          sentence and the score of the emotion atributed by the model.</span>


<span class="sd">          Args:</span>
<span class="sd">            **emot_pipe (pipeline)**: pass a pipeline in order to change the model being used to classify the emotions.</span>

<span class="sd">            **encoder_text (encoder)**: pass the encoder used in the pipeline passed.</span>

<span class="sd">            **redo (bool)**: This function saves if it was already used before, avoiding repeating the repeated work if, for example,</span>
<span class="sd">            the multimodal classification is used but the text modality has already been done before. Setting this to True </span>
<span class="sd">            will force it to repeat the work.</span>

<span class="sd">          Return:</span>
<span class="sd">            Nothing.</span>
<span class="sd">          </span>
<span class="sd">          The current implementation is based on a Roberta model trained on goemotions, but since the goemotions database is in english</span>
<span class="sd">          there is a pre processing of translating the text in portuguese to english with this Unicamp project https://huggingface.co/unicamp-dl/translation-pt-en-t5</span>
<span class="sd">          </span>
<span class="sd">          You can also change the model being used for the emotion recognition with the emot_pipe and encoder_text arguments, </span>
<span class="sd">          although you may need to add the labels that are classified by the new model via the method add_emotions() </span>
<span class="sd">          if they are not present in the self.emotions_coord dataframe</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;text_label&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">redo</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Text classification already done&quot;</span><span class="p">)</span>
          <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">size</span>

          <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading the translator&quot;</span><span class="p">)</span>
          <span class="n">tokenizer_tr</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;unicamp-dl/translation-pt-en-t5&quot;</span><span class="p">)</span>

          <span class="n">translator</span> <span class="o">=</span> <span class="n">AutoModelForSeq2SeqLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;unicamp-dl/translation-pt-en-t5&quot;</span><span class="p">)</span>

          <span class="n">pten_pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span><span class="s1">&#39;text2text-generation&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">translator</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer_tr</span><span class="p">)</span>

          <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully loaded, now applying&quot;</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;Translation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">__traduz</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">pten_pipeline</span><span class="p">,)))</span>

          <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading the classifier&quot;</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">emot_pipe</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">emot_pipe</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span><span class="s1">&#39;sentiment-analysis&#39;</span><span class="p">,</span>
                              <span class="n">model</span><span class="o">=</span><span class="s2">&quot;bhadresh-savani/bert-base-go-emotion&quot;</span><span class="p">,</span>
                              <span class="n">return_all_scores</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
          <span class="n">encoder_text</span> <span class="o">=</span> <span class="n">encoder_text</span> <span class="ow">or</span> <span class="n">SentenceTransformer</span><span class="p">(</span><span class="s2">&quot;bhadresh-savani/bert-base-go-emotion&quot;</span><span class="p">)</span>

          <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully loaded, now applying&quot;</span><span class="p">)</span>
          <span class="n">resp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;Translation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">__emocao_provavel</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">emot_pipe</span><span class="p">,)))</span>
          <span class="n">temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;text_label&#39;</span><span class="p">,</span> <span class="s1">&#39;text_prob&#39;</span><span class="p">])</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;text_embeddings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;Translation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">__encoder_text_adj</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">encoder_text</span><span class="p">,)))</span>

          <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">temp</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dataframe emotions classified&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There is no transcription&quot;</span><span class="p">)</span></div>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    audio</span>
<span class="sd">    -----</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="VideoEmotionRecognition.audio"><a class="viewcode-back" href="../../modules.html#VideoEmotionRecognition.viemr.VideoEmotionRecognition.audio">[docs]</a>    <span class="k">def</span> <span class="nf">audio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;Rajaram1996/Hubert_emotion&quot;</span><span class="p">,</span> <span class="n">redo</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">          One of the main functions of this module. It&#39;s responsible for classifying</span>
<span class="sd">          the emotions present in the sentences of a clip based on it&#39;s audio. </span>
<span class="sd">          </span>
<span class="sd">          Can be used manually or indirectly via the emotion_recogniton(modality = &quot;audio&quot;) method to generate a dataframe</span>
<span class="sd">          with each sentence of a video transcripted with it&#39;s timestamps, the emotion that is predominant in it&#39;s audio </span>
<span class="sd">          segment and the score of the emotion atributed by the model.</span>

<span class="sd">          Args:</span>
<span class="sd">            **method** : placeholder for future integration of new models.</span>
<span class="sd">            </span>
<span class="sd">            **redo (bool)**: This function saves if it was already used before, avoiding repeating the repeated work if, for example,</span>
<span class="sd">            the multimodal classification is used but the text modality has already been done before. Setting this to True </span>
<span class="sd">            will force it to repeat the work.</span>

<span class="sd">          Return:</span>
<span class="sd">            Nothing.</span>

<span class="sd">          The current implementation is based on a Hubert model that can be found here https://github.com/m3hrdadfi/soxan</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;audio_label&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">redo</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Audio classification already done&quot;</span><span class="p">)</span>
          <span class="k">return</span>

        <span class="n">model_name_or_path</span> <span class="o">=</span> <span class="n">method</span>

        <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">AutoConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">)</span>
        <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">Wav2Vec2FeatureExtractor</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">)</span>
        <span class="n">sampling_rate</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="o">.</span><span class="n">sampling_rate</span>


        <span class="c1">#audio_model = HubertForSpeechClassification.from_pretrained(&quot;Rajaram1996/Hubert_emotion&quot;, output_hidden_states=True).to(device)</span>
        <span class="n">video</span> <span class="o">=</span> <span class="n">VideoFileClip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp4</span><span class="p">)</span>

        <span class="n">emot</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">scor</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">maximo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running the Hubert classification for each sentence&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">maximo</span><span class="p">):</span>
            <span class="c1">#Usando os timestamps da transcricao, corto o audio separando cada frase</span>
            <span class="n">startPos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">endPos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

            <span class="n">clip</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">subclip</span><span class="p">(</span><span class="n">startPos</span><span class="p">,</span> <span class="n">endPos</span><span class="p">)</span>

            <span class="n">part_name</span> <span class="o">=</span> <span class="s2">&quot;part_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.mp3&quot;</span>
            <span class="n">clip</span><span class="o">.</span><span class="n">audio</span><span class="o">.</span><span class="n">write_audiofile</span><span class="p">(</span><span class="n">part_name</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1">#Aplico o modelo</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">__predict</span><span class="p">(</span><span class="n">part_name</span><span class="p">,</span><span class="n">sampling_rate</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">feature_extractor</span><span class="p">,</span> <span class="n">audio_model</span><span class="p">)</span>
            <span class="n">embeddings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">__encoder_audio</span><span class="p">(</span><span class="n">part_name</span><span class="p">,</span><span class="n">sampling_rate</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">feature_extractor</span><span class="p">,</span> <span class="n">audio_model</span><span class="p">))</span>

            <span class="n">max_values</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">])</span>

            <span class="c1"># A cada frase, atribuo a emocao mais provavel e sua probabilidade</span>
            <span class="n">max_emotion</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_values</span><span class="p">[</span><span class="s1">&#39;Emotion&#39;</span><span class="p">])</span>
            <span class="n">max_emotion</span> <span class="o">=</span> <span class="n">max_emotion</span><span class="p">[(</span><span class="n">max_emotion</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span> <span class="mi">1</span><span class="p">):]</span>
            <span class="k">if</span> <span class="n">max_emotion</span> <span class="o">==</span> <span class="s1">&#39;sad&#39;</span><span class="p">:</span>
              <span class="n">max_emotion</span> <span class="o">=</span> <span class="s1">&#39;sadness&#39;</span>
            <span class="k">elif</span> <span class="n">max_emotion</span> <span class="o">==</span> <span class="s1">&#39;angry&#39;</span><span class="p">:</span>
              <span class="n">max_emotion</span> <span class="o">=</span> <span class="s1">&#39;anger&#39;</span>
            <span class="k">elif</span> <span class="n">max_emotion</span> <span class="o">==</span> <span class="s1">&#39;happy&#39;</span><span class="p">:</span>
              <span class="n">max_emotion</span> <span class="o">=</span> <span class="s1">&#39;joy&#39;</span>
            <span class="n">emot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_emotion</span><span class="p">)</span>

            <span class="n">max_score</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_values</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">])</span>
            <span class="n">scor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">max_score</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">part_name</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;audio_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">emot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;audio_prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;audio_embeddings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">embeddings</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully generated the dataframe&quot;</span><span class="p">)</span></div>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    video</span>
<span class="sd">    -----</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="VideoEmotionRecognition.video"><a class="viewcode-back" href="../../modules.html#VideoEmotionRecognition.viemr.VideoEmotionRecognition.video">[docs]</a>    <span class="k">def</span> <span class="nf">video</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frames</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">redo</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        One of the main functions of this module. It&#39;s responsible for classifying</span>
<span class="sd">        the emotions present in the sentences of a clip based on the facial expressions present.</span>
<span class="sd">        </span>
<span class="sd">        Can be used manually or indirectly via the emotion_recogniton(modality = &quot;video&quot;) method to generate a dataframe</span>
<span class="sd">        with each sentence of a video transcripted with it&#39;s timestamps, the emotion that is predominant in the facial</span>
<span class="sd">        expressions present and the score of the emotion atributed by the model.</span>

<span class="sd">        Args:</span>
<span class="sd">            **frames (int)**: change the amount of frames per second going to be analized by the model. Bigger values can</span>
<span class="sd">            improve the classification, but drastically increasing the time of execution.</span>

<span class="sd">            **redo (bool)**: This function saves if it was already used before, avoiding repeating the repeated work if, for example,</span>
<span class="sd">            the multimodal classification is used but the text modality has already been done before. Setting this to True </span>
<span class="sd">            will force it to repeat the work.</span>

<span class="sd">          Return:</span>
<span class="sd">            Nothing.</span>

<span class="sd">          The current implementation is based on a Deepface, which can be found here https://github.com/serengil/deepface</span>

<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="s1">&#39;video_label&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">redo</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Video classification already done&quot;</span><span class="p">)</span>
          <span class="k">return</span>
      <span class="n">video</span> <span class="o">=</span> <span class="n">VideoFileClip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp4</span><span class="p">)</span>
      <span class="n">face_cascade</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CascadeClassifier</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">haarcascades</span> <span class="o">+</span> <span class="s1">&#39;haarcascade_frontalface_default.xml&#39;</span><span class="p">)</span>

      <span class="n">new_clip</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">set_fps</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
      <span class="n">emot</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">scor</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">maximo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">maximo</span><span class="p">):</span>
          <span class="c1">#Usando os timestamps da transcricao, corto o audio separando cada frase</span>
          <span class="n">startPos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
          <span class="n">endPos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

          <span class="n">clip</span> <span class="o">=</span> <span class="n">new_clip</span><span class="o">.</span><span class="n">subclip</span><span class="p">(</span><span class="n">startPos</span><span class="p">,</span> <span class="n">endPos</span><span class="p">)</span>

          <span class="n">frames</span> <span class="o">=</span> <span class="n">clip</span><span class="o">.</span><span class="n">iter_frames</span><span class="p">()</span>

          <span class="n">total</span> <span class="o">=</span> <span class="p">{}</span>
          <span class="n">quant</span> <span class="o">=</span> <span class="mi">0</span>

          <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">:</span>

            <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

            <span class="n">faces</span> <span class="o">=</span> <span class="n">face_cascade</span><span class="o">.</span><span class="n">detectMultiScale</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="c1">#Se não tiver face, essa função uma tupla vazia</span>

            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">faces</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
              <span class="k">try</span><span class="p">:</span>
                <span class="c1">#Se não tiver face, essa função retorna uma excecao</span>
                <span class="n">objs</span> <span class="o">=</span> <span class="n">DeepFace</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;emotion&#39;</span><span class="p">])</span>
                <span class="k">if</span><span class="p">(</span><span class="n">total</span> <span class="o">==</span> <span class="p">{}):</span>
                  <span class="n">total</span> <span class="o">=</span> <span class="n">objs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;emotion&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                  <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;emotion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">total</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span>
                <span class="n">quant</span> <span class="o">+=</span> <span class="mi">1</span>
              <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
          <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">total</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">total</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">/</span> <span class="n">quant</span>
          <span class="k">if</span><span class="p">(</span><span class="n">quant</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">emot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;no_face&quot;</span><span class="p">)</span>
            <span class="n">scor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">max_prob</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">total</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">max_emo</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">total</span> <span class="k">if</span> <span class="n">total</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_prob</span><span class="p">}</span>

            <span class="c1">#Max emo eh um set, converto para o formato certo em str</span>
            <span class="n">max_emo</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_emo</span><span class="p">)</span>
            <span class="n">max_emo</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_emo</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">max_emo</span>

            <span class="k">if</span> <span class="n">max_emo</span> <span class="o">==</span> <span class="s1">&#39;sad&#39;</span><span class="p">:</span>
              <span class="n">max_emo</span> <span class="o">=</span> <span class="s1">&#39;sadness&#39;</span>
            <span class="k">elif</span> <span class="n">max_emo</span> <span class="o">==</span> <span class="s1">&#39;angry&#39;</span><span class="p">:</span>
              <span class="n">max_emo</span> <span class="o">=</span> <span class="s1">&#39;anger&#39;</span>
            <span class="k">elif</span> <span class="n">max_emo</span> <span class="o">==</span> <span class="s1">&#39;happy&#39;</span><span class="p">:</span>
              <span class="n">max_emo</span> <span class="o">=</span> <span class="s1">&#39;joy&#39;</span>
            <span class="n">emot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_emo</span><span class="p">)</span>
            <span class="n">scor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_prob</span><span class="o">/</span><span class="p">(</span><span class="n">quant</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;video_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">emot</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;video_prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scor</span></div>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    emotion_recognition</span>
<span class="sd">    -------------------</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="VideoEmotionRecognition.emotion_recognition"><a class="viewcode-back" href="../../modules.html#VideoEmotionRecognition.viemr.VideoEmotionRecognition.emotion_recognition">[docs]</a>    <span class="k">def</span> <span class="nf">emotion_recognition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modality</span><span class="p">,</span> <span class="n">text_pipeline</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">text_encoder</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">audio_method</span> <span class="o">=</span> <span class="s2">&quot;Rajaram1996/Hubert_emotion&quot;</span><span class="p">,</span> <span class="n">video_frames</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">redo</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main functionality that classifies the emotions present in a clip. The modality determines which aspect of the video</span>
<span class="sd">        will be used to classify the emotions</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            **modality (string)**: Choose which way you want the video to be analyzed between 4 possibilities</span>
<span class="sd">            * transcript: classify the emotions based on the transcription of it&#39;s audio</span>
<span class="sd">            * audio: classify the emotions based on it&#39;s audio</span>
<span class="sd">            * video: classify the emotions based on the facial expressions present</span>
<span class="sd">            * multimodal: classify the emotions using both the text and audio modalityes, which are integrated using a graph model.</span>

<span class="sd">            **text_pipe (pipeline)**: pass a pipeline in order to change the model being used to classify the emotions.</span>

<span class="sd">            **text_encoder (encoder)**: pass the encoder used in the pipeline passed.</span>

<span class="sd">            **video_frames (int)**: change the amount of frames per second going to be analized by the model. Bigger values can</span>
<span class="sd">            improve the classification, but drastically increasing the time of execution.</span>

<span class="sd">            **redo (bool)**: This function saves if it was already used before, avoiding repeating the repeated work if, for example,</span>
<span class="sd">            the multimodal classification is used but the text modality has already been done before. Setting this to True </span>
<span class="sd">            will force it to repeat the work.</span>

<span class="sd">        Return:</span>
<span class="sd">            Nothing.</span>

<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">maximo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No transcript found, generating one first&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transcript</span><span class="p">()</span>
        <span class="n">maximo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

      <span class="k">if</span><span class="p">(</span><span class="n">modality</span> <span class="o">==</span> <span class="s2">&quot;transcript&quot;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initialzing the transcription&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">text_pipeline</span><span class="p">,</span><span class="n">text_encoder</span><span class="p">,</span><span class="n">redo</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ending the transcription&quot;</span><span class="p">)</span>

      <span class="k">elif</span><span class="p">(</span><span class="n">modality</span> <span class="o">==</span> <span class="s2">&quot;audio&quot;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initialzing the audio classification&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audio</span><span class="p">(</span><span class="n">audio_method</span><span class="p">,</span><span class="n">redo</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ending the audio classification&quot;</span><span class="p">)</span>

      <span class="k">elif</span><span class="p">(</span><span class="n">modality</span> <span class="o">==</span> <span class="s2">&quot;video&quot;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initialzing the video classification&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video</span><span class="p">(</span><span class="n">video_frames</span><span class="p">,</span><span class="n">redo</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ending the video classification&quot;</span><span class="p">)</span>

      <span class="k">elif</span><span class="p">(</span><span class="n">modality</span> <span class="o">==</span> <span class="s2">&quot;multimodal&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initialzing the transcription&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">text_pipeline</span><span class="p">,</span><span class="n">text_encoder</span><span class="p">,</span><span class="n">redo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ending the transcription&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initialzing the audio classification&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audio</span><span class="p">(</span><span class="n">audio_method</span><span class="p">,</span><span class="n">redo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ending the audio classification&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating the graph&quot;</span><span class="p">)</span>

        <span class="n">A_text</span> <span class="o">=</span> <span class="n">kneighbors_graph</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">text_embeddings</span><span class="o">.</span><span class="n">to_list</span><span class="p">()),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;connectivity&#39;</span><span class="p">)</span>
        <span class="n">G_text</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">A_text</span><span class="o">.</span><span class="n">toarray</span><span class="p">())</span>

        <span class="n">A_audio</span> <span class="o">=</span> <span class="n">kneighbors_graph</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">audio_embeddings</span><span class="o">.</span><span class="n">to_list</span><span class="p">()),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;connectivity&#39;</span><span class="p">)</span>
        <span class="n">G_audio</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">A_audio</span><span class="o">.</span><span class="n">toarray</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">G_multimodal</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">G_text</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span> <span class="bp">self</span><span class="o">.</span><span class="n">G_multimodal</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">G_audio</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span> <span class="bp">self</span><span class="o">.</span><span class="n">G_multimodal</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">t</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
          <span class="n">df_coord_text</span> <span class="o">=</span> <span class="n">__generate_coord</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;text_label&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">emotions_coord</span><span class="p">)</span>
          <span class="n">coord_text</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">df_coord_text</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">df_coord_text</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">G_multimodal</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coord_text</span><span class="p">)</span>

          <span class="n">df_coord_audio</span> <span class="o">=</span> <span class="n">__generate_coord</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;audio_label&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">emotions_coord</span><span class="p">)</span>
          <span class="n">coord_audio</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">df_coord_audio</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">df_coord_audio</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">G_multimodal</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;audio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coord_audio</span><span class="p">)</span>

          <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G_multimodal</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;audio&#39;</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">G_multimodal</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;text&#39;</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">G_multimodal</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;pseudolabeling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ending the multimodal classification&quot;</span><span class="p">)</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    set_vtt</span>
<span class="sd">    -------</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="VideoEmotionRecognition.set_vtt"><a class="viewcode-back" href="../../modules.html#VideoEmotionRecognition.viemr.VideoEmotionRecognition.set_vtt">[docs]</a>    <span class="k">def</span> <span class="nf">set_vtt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          Alternate form to load a video dataframe via it&#39;s vtt, which can be generated previously with the whisperx transcription.</span>

<span class="sd">          Args:</span>
<span class="sd">            **file (vtt)**: path to the vtt file to be used.</span>

<span class="sd">        Return:</span>
<span class="sd">            Nothing.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading dataframe via vtt&quot;</span><span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">caption</span> <span class="ow">in</span> <span class="n">webvtt</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
            <span class="n">L</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">caption</span><span class="o">.</span><span class="n">start</span><span class="p">,</span><span class="n">caption</span><span class="o">.</span><span class="n">end</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">caption</span><span class="o">.</span><span class="n">text</span><span class="p">)])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully loaded&quot;</span><span class="p">)</span></div>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get_labels</span>
<span class="sd">    ----------</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="VideoEmotionRecognition.get_labels"><a class="viewcode-back" href="../../modules.html#VideoEmotionRecognition.viemr.VideoEmotionRecognition.get_labels">[docs]</a>    <span class="k">def</span> <span class="nf">get_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modality</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          Return the dataframe with all sentences, classificated or not. With</span>
<span class="sd">          modality, you can select to show only the classification for the</span>
<span class="sd">          modality selected in case of multiple classifications. Doesn&#39;t work</span>
<span class="sd">          for multimodal since there is no classification.</span>

<span class="sd">          The emotions and probability assigned by the model are shon respectively int the label and prob columns.</span>

<span class="sd">          Args:</span>
<span class="sd">            **modality (string)** Choose which way you want the video to be analyzed between 4 possibilities</span>
<span class="sd">            * transcript: classify the emotions based on the transcription of it&#39;s audio</span>
<span class="sd">            * audio: classify the emotions based on it&#39;s audio</span>
<span class="sd">            * video: show the classified emotions based on the facial expressions present. </span>
<span class="sd">            * all: If either no modality argument is passed or the all modality is used, it will show all the modalities performed </span>
<span class="sd">            in it&#39;s own columns(for example, text in text_label), while the label and prob column show the results of the modality </span>
<span class="sd">            that was selected the last time this method was called.</span>

<span class="sd">        Return:</span>
<span class="sd">            Nothing.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">modality</span> <span class="o">==</span> <span class="s2">&quot;transcript&quot;</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;text_label&quot;</span><span class="p">]</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;prob&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;text_prob&quot;</span><span class="p">]</span>
          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;label&#39;</span><span class="p">,</span><span class="s1">&#39;prob&#39;</span><span class="p">]]</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">modality</span> <span class="o">==</span> <span class="s2">&quot;audio&quot;</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;audio_label&quot;</span><span class="p">]</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;prob&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;audio_prob&quot;</span><span class="p">]</span>
          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;label&#39;</span><span class="p">,</span><span class="s1">&#39;prob&#39;</span><span class="p">]]</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">modality</span> <span class="o">==</span> <span class="s2">&quot;video&quot;</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;video_label&quot;</span><span class="p">]</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;prob&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;video_prob&quot;</span><span class="p">]</span>
          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;label&#39;</span><span class="p">,</span><span class="s1">&#39;prob&#39;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span></div>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get_heatmap</span>
<span class="sd">    -----------</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="VideoEmotionRecognition.get_heatmap"><a class="viewcode-back" href="../../modules.html#VideoEmotionRecognition.viemr.VideoEmotionRecognition.get_heatmap">[docs]</a>    <span class="k">def</span> <span class="nf">get_heatmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modality</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">animated</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">window</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="n">stride</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">join_video</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          Generates a heatmap of the evolution of emotions during the video. This function should be used after </span>
<span class="sd">          the emotion_recognition has been used at least once with any modality. Ithout any special flags, this method</span>
<span class="sd">          generates an image of a heatmap with the overall emotions of the video, but with the right flags, this image</span>
<span class="sd">          cn be instead a video demonstrating the evolution of the emotions with the passage of time and even integrate</span>
<span class="sd">          this video with the original one from which the emotions were extracted.</span>

<span class="sd">          Args:</span>
<span class="sd">            **animated (bool)** instead of a single image, generate a video showing the emotions during the timestamps,</span>
<span class="sd">            which can be adjusted via the window and stride parameters.</span>

<span class="sd">            **window (int)**: size in seconds of the window shown in the animated heatmap. Only works if animated = True. </span>
<span class="sd">            This also changes the heatmap generate with join_video = True</span>

<span class="sd">            **stride (int)**: size in seconds of the difference between two consecutives timeframes. Only works if animated = True. </span>
<span class="sd">            This also changes the heatmap generate with join_video = True</span>

<span class="sd">            **join_video (bool)**: create a new video with the original video and the heatmap video side by side. Only works if animated = True.</span>

<span class="sd">            **modality (string)** Choose which way you want the video to be analyzed between 4 possibilities</span>
<span class="sd">            * transcript: classify the emotions based on the transcription of it&#39;s audio</span>
<span class="sd">            * audio: classify the emotions based on it&#39;s audio</span>
<span class="sd">            * video: show the classified emotions based on the facial expressions present.</span>
<span class="sd">            * multimodal: classify the emotions using both the text and audio modalityes, which are integrated using a graph model. </span>
<span class="sd">            * all: If either no modality argument is passed or the all modality is used, it will show all the modalities performed </span>
<span class="sd">            in it&#39;s own columns(for example, text in text_label), while the label and prob column show the results of the modality </span>
<span class="sd">            that was selected the last time this method was called.</span>

<span class="sd">        Return:</span>
<span class="sd">            Based on the flags, a plot of the heatmap, a video of the heatmap or a merge of the original video and the video of the heatmap.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">modality</span> <span class="o">==</span> <span class="s1">&#39;multimodal&#39;</span><span class="p">:</span>
          <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
          <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
          <span class="n">__GCP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G_multimodal</span><span class="p">,</span><span class="n">mi</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">audio_weight</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">text_weight</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
          <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G_multimodal</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;f&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">animated</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">or</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.1</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">):</span>
              <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
              <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_labels</span><span class="p">(</span><span class="n">modality</span><span class="p">)</span>

          <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding the arousal valence coordinates&quot;</span><span class="p">)</span>
          <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;no_face&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
          <span class="n">resp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">__generate_coord</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emotions_coord</span><span class="p">,)))</span>
          <span class="n">temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">])</span>

          <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">temp</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">animated</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
              <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">label</span><span class="o">!=</span><span class="s1">&#39;neutral&#39;</span><span class="p">]</span>
              <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

          <span class="n">array_x</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
          <span class="n">x</span> <span class="o">=</span> <span class="n">array_x</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
          <span class="n">array_y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
          <span class="n">y</span> <span class="o">=</span> <span class="n">array_y</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">animated</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating images for the video&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;tempjpgs&quot;</span><span class="p">)</span>
            <span class="n">clip</span> <span class="o">=</span> <span class="n">VideoFileClip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp4</span><span class="p">)</span>

            <span class="n">maximo</span> <span class="o">=</span> <span class="n">clip</span><span class="o">.</span><span class="n">duration</span>
            <span class="n">ini</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">fim</span> <span class="o">=</span> <span class="n">window</span>
            <span class="n">atual</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">id_ini</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">__to_seconds</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ini</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">id_fim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">__to_seconds</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">fim</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">x_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">id_ini</span><span class="p">:</span> <span class="n">id_fim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">y_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">id_ini</span><span class="p">:</span> <span class="n">id_fim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">x_temp</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">y_temp</span><span class="p">):</span>
                  <span class="n">x_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                  <span class="n">y_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                  <span class="n">x_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_temp</span><span class="p">,</span><span class="n">y_temp</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)]</span>
                  <span class="n">y_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">id_ini</span><span class="p">:</span> <span class="n">id_fim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span><span class="n">y_temp</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)]</span>

                <span class="n">__plot_heatmap</span><span class="p">(</span><span class="n">x_temp</span><span class="p">,</span> <span class="n">y_temp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emotions_coord</span><span class="p">,</span> <span class="s2">&quot;animated&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Emotions from &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ini</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; to &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fim</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; seconds&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;tempjpgs/output&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">atual</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.jpg&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">fim</span> <span class="o">&gt;</span> <span class="n">maximo</span><span class="p">:</span>
                  <span class="k">break</span>
                <span class="n">ini</span> <span class="o">+=</span> <span class="n">stride</span>
                <span class="n">fim</span> <span class="o">+=</span> <span class="n">stride</span>
                <span class="n">atual</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Done generating images&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating Video&quot;</span><span class="p">)</span>
            <span class="n">img_array</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;tempjpgs/*.jpg&#39;</span><span class="p">)</span> <span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">__numericalSort</span><span class="p">):</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">layers</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">)</span>
                <span class="n">img_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="s2">&quot;tempjpgs&quot;</span><span class="p">)</span>

            <span class="n">clip</span> <span class="o">=</span> <span class="n">VideoFileClip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mp4</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">clip</span><span class="o">.</span><span class="n">size</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">clip</span><span class="o">.</span><span class="n">fps</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">*</span><span class="n">join_video</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter</span><span class="p">(</span><span class="s1">&#39;heatmap.mp4&#39;</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter_fourcc</span><span class="p">(</span><span class="o">*</span><span class="s1">&#39;XVID&#39;</span><span class="p">),</span> <span class="n">rate</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>


            <span class="k">if</span> <span class="n">join_video</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>

              <span class="n">rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span>
              <span class="n">tam</span> <span class="o">=</span>  <span class="n">window</span>
              <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
              <span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">clip</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
              <span class="n">duration</span> <span class="o">*=</span> <span class="n">rate</span>

              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">img_array</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rate</span> <span class="o">*</span> <span class="n">tam</span><span class="p">):</span>
                  <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="n">duration</span><span class="p">:</span>
                    <span class="k">break</span>
                  <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">img_array</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                  <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">tam</span> <span class="o">=</span> <span class="n">stride</span>
              <span class="k">while</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">duration</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">img_array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">else</span><span class="p">:</span>
              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">img_array</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                  <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">img_array</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="n">out</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

            <span class="n">myvideo</span> <span class="o">=</span> <span class="n">VideoFileClip</span><span class="p">(</span><span class="s1">&#39;heatmap.mp4&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Video created&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">join_video</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Joining Videos&quot;</span><span class="p">)</span>

              <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span>

              <span class="n">bashCommand</span> <span class="o">=</span> <span class="s2">&quot;ffmpeg -y -i heatmap.mp4 -f lavfi -i anullsrc -vcodec copy -acodec aac -shortest theatmap.mp4&quot;</span>
              <span class="n">flag</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">bashCommand</span><span class="p">)</span>

              <span class="n">bashCommand</span> <span class="o">=</span> <span class="s2">&quot;ffmpeg -y -i theatmap.mp4 -filter:v scale=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; sheatmap.mp4&quot;</span>
              <span class="n">flag</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">bashCommand</span><span class="p">)</span>

              <span class="n">bashCommand</span> <span class="o">=</span> <span class="s2">&quot;ffmpeg -y -i &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mp4</span> <span class="o">+</span> <span class="s2">&quot; -i sheatmap.mp4 -filter_complex </span><span class="se">\&quot;</span><span class="s2">[0][1]scale2ref=</span><span class="se">\&#39;</span><span class="s2">oh*mdar</span><span class="se">\&#39;</span><span class="s2">:</span><span class="se">\&#39;</span><span class="s2">if(lt(main_h,ih),ih,main_h)</span><span class="se">\&#39;</span><span class="s2">[0s][1s];[1s][0s]scale2ref=</span><span class="se">\&#39;</span><span class="s2">oh*mdar</span><span class="se">\&#39;</span><span class="s2">:</span><span class="se">\&#39;</span><span class="s2">if(lt(main_h,ih),ih,main_h)</span><span class="se">\&#39;</span><span class="s2">[1s][0s];[0s][1s]hstack,setsar=1; [0:a][1:a]amerge[a]</span><span class="se">\&quot;</span><span class="s2"> -map </span><span class="se">\&quot;</span><span class="s2">[a]</span><span class="se">\&quot;</span><span class="s2"> -ac 2 video_with_heatmap.mp4&quot;</span>
              <span class="n">flag</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">bashCommand</span><span class="p">)</span>

              <span class="k">if</span><span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Videos successufully joined&quot;</span><span class="p">)</span>
              <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Error detected joining videos&quot;</span><span class="p">)</span>

              <span class="k">return</span>

            <span class="k">return</span> <span class="n">ipython_display</span><span class="p">(</span><span class="n">myvideo</span><span class="p">)</span>


        <span class="k">else</span><span class="p">:</span>
          <span class="n">__plot_heatmap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emotions_coord</span><span class="p">,</span> <span class="n">modality</span><span class="p">)</span></div></div>

<span class="c1">#Funcoes auxiliares para classifcar quanto as emocoes</span>
          
<span class="c1">#Translate the sentences from portuguese to english in order to use the text classification model  </span>
<span class="k">def</span> <span class="nf">__traduz</span><span class="p">(</span><span class="n">frase</span><span class="p">,</span> <span class="n">pten_pipeline</span><span class="p">):</span>
    <span class="n">traducao</span> <span class="o">=</span> <span class="n">pten_pipeline</span><span class="p">(</span><span class="n">frase</span><span class="p">)</span>
    <span class="n">traducao</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">traducao</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">traducao</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1">#Função para extrair do dicionario retornado pelo goemotions a emoção mais provável e sua probabilidade</span>
<span class="k">def</span> <span class="nf">__emocao_provavel</span><span class="p">(</span><span class="n">frase</span><span class="p">,</span> <span class="n">emot_pipe</span><span class="p">):</span>
    <span class="n">emotion_labels</span> <span class="o">=</span> <span class="n">emot_pipe</span><span class="p">(</span><span class="n">frase</span><span class="p">)</span>

    <span class="n">maximo</span> <span class="o">=</span> <span class="n">emotion_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;score&quot;</span><span class="p">]</span>
    <span class="n">emocao</span> <span class="o">=</span> <span class="n">emotion_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="nb">dict</span> <span class="ow">in</span> <span class="n">emotion_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">dict</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">maximo</span><span class="p">:</span>
          <span class="n">maximo</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span>
          <span class="n">emocao</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">emocao</span><span class="p">,</span> <span class="n">maximo</span>

<span class="c1">#Funcoes auxiliares para gerar o heatmap</span>

<span class="n">numbers</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\d+)&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">__numericalSort</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
  <span class="n">parts</span> <span class="o">=</span> <span class="n">numbers</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">parts</span>
<span class="k">def</span> <span class="nf">__generate_coord</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;Emotion&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;X&#39;</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">__kde_quartic</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">h</span><span class="p">):</span>
    <span class="n">dn</span><span class="o">=</span><span class="n">d</span><span class="o">/</span><span class="n">h</span>
    <span class="n">P</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="o">/</span><span class="mi">16</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">dn</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">P</span>
<span class="k">def</span> <span class="nf">__plot_heatmap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">emotions_coord</span><span class="p">,</span> <span class="n">modality</span><span class="p">):</span>
    <span class="c1">#Definindo tamanho do grid e do raio(h)</span>
    <span class="n">grid_size</span><span class="o">=</span><span class="mf">0.02</span>
    <span class="n">h</span><span class="o">=</span><span class="mf">0.5</span>

    <span class="c1">#Tomando valores de máximos e mínimos de X e Y.</span>
    <span class="n">x_min</span><span class="o">=-</span><span class="mi">1</span>
    <span class="n">x_max</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">y_min</span><span class="o">=-</span><span class="mi">1</span>
    <span class="n">y_max</span><span class="o">=</span><span class="mi">1</span>

    <span class="c1">#Construindo grid</span>
    <span class="n">x_grid</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x_min</span><span class="o">-</span><span class="n">h</span><span class="p">,</span><span class="n">x_max</span><span class="o">+</span><span class="n">h</span><span class="p">,</span><span class="n">grid_size</span><span class="p">)</span>
    <span class="n">y_grid</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">y_min</span><span class="o">-</span><span class="n">h</span><span class="p">,</span><span class="n">y_max</span><span class="o">+</span><span class="n">h</span><span class="p">,</span><span class="n">grid_size</span><span class="p">)</span>
    <span class="n">x_mesh</span><span class="p">,</span><span class="n">y_mesh</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span><span class="n">y_grid</span><span class="p">)</span>

    <span class="c1">#Determinando ponto central do grid</span>
    <span class="n">xc</span><span class="o">=</span><span class="n">x_mesh</span><span class="o">+</span><span class="p">(</span><span class="n">grid_size</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">yc</span><span class="o">=</span><span class="n">y_mesh</span><span class="o">+</span><span class="p">(</span><span class="n">grid_size</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">intensity_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xc</span><span class="p">)):</span>
        <span class="n">intensity_row</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xc</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="n">kde_value_list</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
                <span class="c1">#Calculando distância</span>
                <span class="n">d</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xc</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">yc</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">d</span><span class="o">&lt;=</span><span class="n">h</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">=</span><span class="n">__kde_quartic</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">h</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">kde_value_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="c1">#Soma os valores de intensidade</span>
            <span class="n">p_total</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">kde_value_list</span><span class="p">)</span>
            <span class="n">intensity_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_total</span><span class="p">)</span>
        <span class="n">intensity_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intensity_row</span><span class="p">)</span>

    <span class="c1">#Saída do Heatmap</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>

    <span class="n">intensity</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">intensity_list</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">x_mesh</span><span class="p">,</span><span class="n">y_mesh</span><span class="p">,</span><span class="n">intensity</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;YlOrRd&#39;</span><span class="p">)</span> <span class="c1">#https://matplotlib.org/stable/tutorials/colors/colormaps.html</span>


    <span class="c1">#fig, ax = plt.subplots()</span>

    <span class="n">x_emo</span> <span class="o">=</span> <span class="n">emotions_coord</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="n">y_emo</span> <span class="o">=</span> <span class="n">emotions_coord</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_emo</span><span class="p">,</span> <span class="n">y_emo</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">emotions_coord</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Emotion&#39;</span><span class="p">],</span> <span class="p">(</span><span class="n">x_emo</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y_emo</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Arousal&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Valence&#39;</span><span class="p">)</span>

    <span class="c1">#plt.colorbar()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>

<span class="c1">#Funcoes auxiliares para a transcricao</span>

<span class="k">def</span> <span class="nf">__time_diff</span><span class="p">(</span><span class="n">fim</span><span class="p">,</span> <span class="n">init</span><span class="p">):</span>

      <span class="n">time_fim</span> <span class="o">=</span> <span class="n">__to_seconds</span><span class="p">(</span><span class="n">fim</span><span class="p">)</span>
      <span class="n">time_init</span> <span class="o">=</span> <span class="n">__to_seconds</span><span class="p">(</span><span class="n">init</span><span class="p">)</span>

      <span class="k">return</span> <span class="n">time_fim</span> <span class="o">-</span> <span class="n">time_init</span>

<span class="k">def</span> <span class="nf">__speech_file_to_array_fn</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="p">):</span>
    <span class="n">speech_array</span><span class="p">,</span> <span class="n">_sampling_rate</span> <span class="o">=</span> <span class="n">torchaudio</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">resampler</span> <span class="o">=</span> <span class="n">torchaudio</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Resample</span><span class="p">(</span><span class="n">_sampling_rate</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="p">)</span>
    <span class="n">speech</span> <span class="o">=</span> <span class="n">resampler</span><span class="p">(</span><span class="n">speech_array</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">speech</span>

<span class="k">def</span> <span class="nf">__encoder_text_adj</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">encoder</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">([</span><span class="n">sentence</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1">#Funcoes auxiliares para a funcionalidade audio</span>

<span class="k">def</span> <span class="nf">__predict</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">feature_extractor</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="n">speech</span> <span class="o">=</span> <span class="n">__speech_file_to_array_fn</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="p">)</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="p">(</span><span class="n">speech</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="o">=</span><span class="n">sampling_rate</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">}</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>

    <span class="n">scores</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;Emotion&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">id2label</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;Score&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">score</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span>
               <span class="nb">enumerate</span><span class="p">(</span><span class="n">scores</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">outputs</span>

    <span class="c1"># extrai os embeddings da predição feita</span>
<span class="k">def</span> <span class="nf">__encoder_audio</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">feature_extractor</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">mean_pool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">speech</span> <span class="o">=</span> <span class="n">__speech_file_to_array_fn</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="p">)</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="p">(</span><span class="n">speech</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="o">=</span><span class="n">sampling_rate</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">}</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span><span class="o">.</span><span class="n">hidden_states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mean_pool</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">cpu</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1">#Funcoes auxiliares para a funcionalidade multimodal</span>
<span class="k">def</span> <span class="nf">__GCP</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">audio_weight</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">text_weight</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">mi</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_diff</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>

  <span class="c1"># inicializando</span>
  <span class="n">L_nodes</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
    <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">([</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;text&#39;</span><span class="p">],</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;audio&#39;</span><span class="p">]],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="n">text_weight</span><span class="p">,</span> <span class="n">audio_weight</span><span class="p">])</span>
    <span class="n">L_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>


  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">max_iter</span><span class="p">):</span>
    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">L_nodes</span><span class="p">)</span>

    <span class="c1"># propagando</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">L_nodes</span><span class="p">:</span>

      <span class="n">f_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
      <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">neighbor</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
        <span class="n">f_new</span> <span class="o">+=</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">neighbor</span><span class="p">][</span><span class="s1">&#39;f&#39;</span><span class="p">]</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

      <span class="n">f_new</span> <span class="o">/=</span> <span class="n">count</span>

      <span class="n">f_pseudolabeling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">([</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;text&#39;</span><span class="p">],</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;audio&#39;</span><span class="p">]],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="n">text_weight</span><span class="p">,</span> <span class="n">audio_weight</span><span class="p">])</span>
      <span class="n">pl</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;pseudolabeling&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">mi</span>
      <span class="n">f_new</span> <span class="o">=</span> <span class="n">f_pseudolabeling</span><span class="o">*</span><span class="n">pl</span> <span class="o">+</span> <span class="n">f_new</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">pl</span><span class="p">)</span>
      <span class="n">diff</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;f&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">f_new</span><span class="p">)</span>
      <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;f&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">f_new</span>


    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Iteration #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; Q(F)=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;=</span> <span class="n">min_diff</span><span class="p">:</span> <span class="k">break</span>

<span class="c1">#Funcoes uteis</span>
<span class="k">def</span> <span class="nf">__to_seconds</span><span class="p">(</span><span class="n">horario</span><span class="p">):</span>

  <span class="n">horario_separado</span> <span class="o">=</span> <span class="n">horario</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
  <span class="n">seconds</span> <span class="o">=</span> <span class="mi">3600</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">horario_separado</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">60</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">horario_separado</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">horario_separado</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

  <span class="k">return</span> <span class="n">seconds</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Artur.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>